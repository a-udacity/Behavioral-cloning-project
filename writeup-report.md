#**Behavioral-cloning-project** 
**Behavioral Cloning Project**

Overview

The objective of this project is to clone human driving behavior using a Deep Neural Network.
In order to achieve this, we are going to use a simple Car Simulator that captures the images from 3 cameras (center, left, right) along with steering angles.
Then those recorded images and the corresponding sheering angles are used to train the 5 layers neural network.
Trained model was tested on two tracks, namely track1 and track2. The two following you videos show the performance of the final model track 1 and track 2 in Autonomous Mode.


[![Evaluation Track](sample/track1.jpg)](https://youtu.be/Xplj9rNayR8)
[![Track 2](sample/track2.jpg)](https://youtu.be/zxCuKIyuFzo)

* model.py - The script used to create and train the model.
* drive.py - The script to drive the car. I have modified to work correctly.
* model.json - The Keras model json
* model.h5 - The trained model.
* ./data/drive_log.csv  - Combined log of simulated data along with sample data provided by udacity.
* model.ipynb - Model Jupyter notebook. Note this also contains the generated images for visualization.....

[//]: # (Image References)
                                             Normal center camera images
![image 1](https://raw.githubusercontent.com/ahararwala/Behavioral-cloning-project/master/sample/normal_center.png "TODO Normal center camera images")

                                             Normal left camera images
![image 2](https://raw.githubusercontent.com/ahararwala/Behavioral-cloning-project/master/sample/normal_left.png "TODO Normal left camera images")

                                             Normal right camera images
![image 3](https://raw.githubusercontent.com/ahararwala/Behavioral-cloning-project/master/sample/normal_right.png "TODO Normal right camera images")

                                             Brigthness Augmented images
![image 7](https://raw.githubusercontent.com/ahararwala/Behavioral-cloning-project/master/sample/brightness_augmentation.png "TODO Pre-process flipped images")

                                             Crop and Resized to 64x64 images
![image 7](https://raw.githubusercontent.com/ahararwala/Behavioral-cloning-project/master/sample/crop_and_resize.png "TODO Pre-process flipped images")

                                             Veritcal Flip of LEFT images
![image 7](https://raw.githubusercontent.com/ahararwala/Behavioral-cloning-project/master/sample/vertical_flip.png "TODO Pre-process flipped images")

                                             Pre-processed center camera images
![image 4](https://raw.githubusercontent.com/ahararwala/Behavioral-cloning-project/master/sample/center.png "Pre-process center camera images")

                                             Pre-processed left camera images
![image 5](https://raw.githubusercontent.com/ahararwala/Behavioral-cloning-project/master/sample/left.png "Pre-process right camera images")

                                             Pre-processed right camera images
![image 6](https://raw.githubusercontent.com/ahararwala/Behavioral-cloning-project/master/sample/right.png "Pre-process left center camera images")


####1. Submission includes all required files and can be used to run the simulator in autonomous mode

My project includes the following files:
* model.py containing the script to create and train the model
* model.ipynb
* drive.py for driving the car in autonomous mode
* model.h5 containing a trained convolution neural network 
* writeup_report.md or writeup_report.pdf summarizing the results
* sample/*.png - visualization of images folder

####2. Submission includes functional code
Using the Udacity provided simulator and my drive.py file, the car can be driven autonomously around the track by executing 
```sh
python drive.py model.json capture_images
```
###Model Architecture and Training Strategy

####1. An appropriate model architecture has been employed

The model includes ELU layers to introduce non-linearity, and the data is normalized in the model using a Keras lambda layer 
The network model is similar to the model from NVIDIA's End to End Learning for Self-Driving Cars paper. 
The main difference between my model and the NVIDIA mode is that dropout layers are used after each Convolutional Layer to avoid overfitting issue. 
The network architecture is as below:

####2. Final Model Architecture

Here is a visualization of the architecture:


<pre>
____________________________________________________________________________________________________
Layer (type)                     Output Shape          Param #     Connected to
====================================================================================================
convolution2d_1 (Convolution2D)  (None, 32, 32, 24)    1824        convolution2d_input_1[0][0]
____________________________________________________________________________________________________
elu_1 (ELU)                      (None, 32, 32, 24)    0           convolution2d_1[0][0]
____________________________________________________________________________________________________
convolution2d_2 (Convolution2D)  (None, 16, 16, 36)    21636       elu_1[0][0]
____________________________________________________________________________________________________
elu_2 (ELU)                      (None, 16, 16, 36)    0           convolution2d_2[0][0]
____________________________________________________________________________________________________
dropout_1 (Dropout)              (None, 16, 16, 36)    0           elu_2[0][0]
____________________________________________________________________________________________________
convolution2d_3 (Convolution2D)  (None, 8, 8, 48)      43248       dropout_1[0][0]
____________________________________________________________________________________________________
elu_3 (ELU)                      (None, 8, 8, 48)      0           convolution2d_3[0][0]
____________________________________________________________________________________________________
dropout_2 (Dropout)              (None, 8, 8, 48)      0           elu_3[0][0]
____________________________________________________________________________________________________
convolution2d_4 (Convolution2D)  (None, 8, 8, 64)      27712       dropout_2[0][0]
____________________________________________________________________________________________________
elu_4 (ELU)                      (None, 8, 8, 64)      0           convolution2d_4[0][0]
____________________________________________________________________________________________________
convolution2d_5 (Convolution2D)  (None, 8, 8, 64)      36928       elu_4[0][0]
____________________________________________________________________________________________________
elu_5 (ELU)                      (None, 8, 8, 64)      0           convolution2d_5[0][0]
____________________________________________________________________________________________________
flatten_1 (Flatten)              (None, 4096)          0           elu_5[0][0]
____________________________________________________________________________________________________
dense_1 (Dense)                  (None, 1164)          4768908     flatten_1[0][0]
____________________________________________________________________________________________________
elu_6 (ELU)                      (None, 1164)          0           dense_1[0][0]
____________________________________________________________________________________________________
dropout_3 (Dropout)              (None, 1164)          0           elu_6[0][0]
____________________________________________________________________________________________________
dense_2 (Dense)                  (None, 100)           116500      dropout_3[0][0]
____________________________________________________________________________________________________
elu_7 (ELU)                      (None, 100)           0           dense_2[0][0]
____________________________________________________________________________________________________
dense_3 (Dense)                  (None, 50)            5050        elu_7[0][0]
____________________________________________________________________________________________________
elu_8 (ELU)                      (None, 50)            0           dense_3[0][0]
____________________________________________________________________________________________________
dense_4 (Dense)                  (None, 10)            510         elu_8[0][0]
____________________________________________________________________________________________________
elu_9 (ELU)                      (None, 10)            0           dense_4[0][0]
____________________________________________________________________________________________________
dense_5 (Dense)                  (None, 1)             11          elu_9[0][0]
====================================================================================================
Total params: 5,022,327
Trainable params: 5,022,327
Non-trainable params: 0
____________________________________________________________________________________________________
</pre>

####2. Attempts to reduce over fitting in the model

The model contains dropout layers in order to reduce over fitting (model.py lines 21). 
The model was trained and validated on different data sets to ensure that the model was not over fitting (code line 10-16). 
The model was tested by running it through the simulator and ensuring that the vehicle could stay on the track.
The Udacity dataset containing 8037 images were augmented by running simulation using that Beta simulator provided.
I generated approximately 5000 extra images which were divided into 80% for training and 20% for validation. 
I made sure that I captured different angles and turns while capturing the data but since I was using a mouse, I could not run
the simulation smoothly which appeared in the actual run.

Each training epoch consumes 20000 images, which are generated on the fly using the data augmentation described above. 
In addition to that, 3000 images also generated on the fly for validation. 
We used Adam optimizer with default 0.001 learning rate.
55 training epochs are able to produce the weights that work well on both training and validation tracks.

<pre>
Epoch 1/55
20000/20000 [==============================] - 265s - loss: 0.9080 - val_loss: 0.0355
Epoch 2/55
20000/20000 [==============================] - 183s - loss: 0.7271 - val_loss: 0.0404
Epoch 3/55
20000/20000 [==============================] - 185s - loss: 0.6141 - val_loss: 0.1035
Epoch 4/55
20000/20000 [==============================] - 186s - loss: 0.5248 - val_loss: 0.0077
Epoch 5/55
20000/20000 [==============================] - 185s - loss: 0.4459 - val_loss: 3.1760e-05
Epoch 6/55
20000/20000 [==============================] - 185s - loss: 0.3729 - val_loss: 0.0052
Epoch 7/55
20000/20000 [==============================] - 182s - loss: 0.3121 - val_loss: 0.0052
Epoch 8/55
20000/20000 [==============================] - 183s - loss: 0.2556 - val_loss: 0.0012
Epoch 9/55
20000/20000 [==============================] - 183s - loss: 0.2075 - val_loss: 0.0030
Epoch 10/55
20000/20000 [==============================] - 183s - loss: 0.1644 - val_loss: 1.7430e-06
Epoch 11/55
20000/20000 [==============================] - 182s - loss: 0.1290 - val_loss: 8.2490e-04
Epoch 12/55
20000/20000 [==============================] - 181s - loss: 0.1008 - val_loss: 0.0064
Epoch 13/55
20000/20000 [==============================] - 180s - loss: 0.0761 - val_loss: 0.0020
Epoch 14/55
20000/20000 [==============================] - 187s - loss: 0.0236 - val_loss: 3.6590e-05
Epoch 22/55
20000/20000 [==============================] - 184s - loss: 0.0218 - val_loss: 7.9003e-08
Epoch 32/55
20000/20000 [==============================] - 184s - loss: 0.0209 - val_loss: 2.1022e-05
Epoch 34/55
20000/20000 [==============================] - 184s - loss: 0.0207 - val_loss: 0.0017
Epoch 37/55
20000/20000 [==============================] - 184s - loss: 0.0199 - val_loss: 2.7980e-04
Epoch 40/55
20000/20000 [==============================] - 183s - loss: 0.0192 - val_loss: 0.0021
Epoch 43/55
20000/20000 [==============================] - 183s - loss: 0.0190 - val_loss: 7.5765e-04
Epoch 46/55
20000/20000 [==============================] - 183s - loss: 0.0186 - val_loss: 1.5610e-05
Epoch 48/55
20000/20000 [==============================] - 184s - loss: 0.0182 - val_loss: 4.1010e-07
Epoch 50/55
20000/20000 [==============================] - 184s - loss: 0.0179 - val_loss: 5.1876e-04
Epoch 52/55
20000/20000 [==============================] - 184s - loss: 0.0180 - val_loss: 0.0014
Epoch 54/55
20000/20000 [==============================] - 183s - loss: 0.0177 - val_loss: 7.9858e-04
</pre>


####4. Appropriate training data

Training data was chosen to keep the vehicle driving on the road. 
I used a combination of center lane driving, recovering from the left and right sides of the road and captured approximately
5000 images that I merged with the data images and log provided by Udacity. I was not able to maintain the smoothness of the turn
since i was using a mouse to run the car in simulation and spend approximately 1/2 a day capturing the data after some practice.

####1. Creation of the Training Set & Training Process

To capture good driving behavior, I first recorded one lap on track 1 and approximately one using center lane driving on track 2. 
@see visualization of images above. 
I then recorded the vehicle recovering from the left side and right sides of the road back to center so that the vehicle would learn to make both 
the left turn and right turn. 

After the collection process, I had 5000 extra images. I then preprocessed this data by doing the following:
* Brightness Augmentation (@see images above)
* Crop and resize to 64 x 64 for keras model. The crop was done is such a way that the car and hood was removed first instead of 
 cropping evenly. This allowed the model to focus more on the road. (@see images above)
* Vertical Flip. To show the network equal amounts of left and right turn steering angle. I used 50 percent probability in my generator to generate an image with the right labels or flipped the image and changed the sign of the steering angle.  (@see images above)
* Camera image - since we had three images per row (center, left, right). I chose camera image randomly and applied the necessary
 calculations to change the steering angle

I finally randomly shuffled the data set and put 20% of the data into a validation set. 
I used this training data for training the model. The validation set helped determine if the model was over or under fitting. 
The ideal number of epochs was 55.

###Results
I kept the models that is good enough for validation set. To evaluate my trained model, I designed the data to show me a random sequence with the ground truth and predicted steering angle and I justified the model manually before the run in the simulator.
This approach is great if you check that in the ordered dataset according to time @ see the top section for my results on Track 1 and Track 2.

###Conclusions
This was really an interesting project that challenged and excited me. It was very satisfying to actually go through the whole
   process of capturing the data to training the model, and then testing it on two tracks. I also learned the importance of a large data set and capturing relevant data (for example the different angles).
   I was also able to engage my 12 year daughter to capture the data which was fun.
   I did end up working long hours in the night including sacrificing my weekends but it was all worth it.
   
   
   
